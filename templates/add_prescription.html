{% extends "base.html" %}

{% block title %}New Prescription{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-plus"></i> Create New Prescription</h2>
                <a href="{{ url_for('prescriptions') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Prescriptions
                </a>
            </div>

            <form method="POST" id="prescriptionForm">
                {{ form.hidden_tag() }}
                
                <div class="row">
                    <!-- Patient Information -->
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5><i class="fas fa-user"></i> Patient Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    {{ form.patient_id.label(class="form-label") }}
                                    {{ form.patient_id(class="form-select") }}
                                    {% if form.patient_id.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.patient_id.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Patient details will be shown here -->
                                <div id="patientDetails" class="d-none">
                                    <div class="alert alert-info">
                                        <div class="row">
                                            <div class="col-6">
                                                <strong>Name:</strong> <span id="patientName"></span><br>
                                                <strong>Age:</strong> <span id="patientAge"></span><br>
                                                <strong>Gender:</strong> <span id="patientGender"></span>
                                            </div>
                                            <div class="col-6">
                                                <strong>Phone:</strong> <span id="patientPhone"></span><br>
                                                <strong>Blood Group:</strong> <span id="patientBloodGroup"></span><br>
                                                <strong>Allergies:</strong> <span id="patientAllergies"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Prescription Details -->
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5><i class="fas fa-stethoscope"></i> Prescription Details</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    {{ form.doctor_name.label(class="form-label") }}
                                    {{ form.doctor_name(class="form-control") }}
                                    {% if form.doctor_name.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.doctor_name.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    {{ form.prescription_date.label(class="form-label") }}
                                    {{ form.prescription_date(class="form-control") }}
                                    {% if form.prescription_date.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.prescription_date.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    {{ form.diagnosis.label(class="form-label") }}
                                    {{ form.diagnosis(class="form-control", rows="3") }}
                                    {% if form.diagnosis.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.diagnosis.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    {{ form.notes.label(class="form-label") }}
                                    {{ form.notes(class="form-control", rows="2") }}
                                    {% if form.notes.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.notes.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Prescription Items -->
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5><i class="fas fa-pills"></i> Medicines</h5>
                            <button type="button" class="btn btn-sm btn-primary" onclick="addMedicineRow()">
                                <i class="fas fa-plus"></i> Add Medicine
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered" id="medicineTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Medicine</th>
                                        <th>Dosage</th>
                                        <th>Frequency</th>
                                        <th>Duration (Days)</th>
                                        <th>Instructions</th>
                                        <th>Quantity</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="medicineTableBody">
                                    <!-- Medicine rows will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                        <div class="text-end mt-3">
                            <h5>Total Amount: â‚¹<span id="totalAmount">0.00</span></h5>
                        </div>
                    </div>
                </div>

                <!-- Submit Buttons -->
                <div class="card">
                    <div class="card-body text-end">
                        <a href="{{ url_for('prescriptions') }}" class="btn btn-secondary me-2">Cancel</a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Prescription
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Hidden template for medicine row -->
<div id="medicineRowTemplate" class="d-none">
    <tr class="medicine-row">
        <td>
            <select class="form-select medicine-select" name="medicine_id[]" onchange="updateMedicinePrice(this)">
                <option value="">Select Medicine</option>
                {% for medicine in medicines %}
                <option value="{{ medicine.id }}" data-price="{{ medicine.selling_price }}" data-stock="{{ medicine.quantity }}">
                    {{ medicine.name }} - {{ medicine.manufacturer }} (Stock: {{ medicine.quantity }})
                </option>
                {% endfor %}
            </select>
        </td>
        <td>
            <input type="text" class="form-control" name="dosage[]" placeholder="e.g., 500mg">
        </td>
        <td>
            <select class="form-select" name="frequency[]">
                <option value="">Select Frequency</option>
                <option value="Once daily">Once daily</option>
                <option value="Twice daily">Twice daily</option>
                <option value="Three times daily">Three times daily</option>
                <option value="Four times daily">Four times daily</option>
                <option value="Every 4 hours">Every 4 hours</option>
                <option value="Every 6 hours">Every 6 hours</option>
                <option value="Every 8 hours">Every 8 hours</option>
                <option value="As needed">As needed</option>
            </select>
        </td>
        <td>
            <input type="number" class="form-control" name="duration_days[]" min="1" placeholder="Days">
        </td>
        <td>
            <input type="text" class="form-control" name="instructions[]" placeholder="Take after meals">
        </td>
        <td>
            <input type="number" class="form-control quantity-input" name="quantity[]" min="1" 
                   onchange="updateRowTotal(this)" placeholder="Qty">
        </td>
        <td>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeMedicineRow(this)">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    </tr>
</div>

<script>
let medicineRowCounter = 0;
const patientData = {{ patients_json|safe }};

// Patient selection handler
document.getElementById('patient_id').addEventListener('change', function() {
    const patientId = this.value;
    const patientDetails = document.getElementById('patientDetails');
    
    if (patientId && patientData[patientId]) {
        const patient = patientData[patientId];
        document.getElementById('patientName').textContent = patient.first_name + ' ' + patient.last_name;
        document.getElementById('patientAge').textContent = patient.age || 'N/A';
        document.getElementById('patientGender').textContent = patient.gender || 'N/A';
        document.getElementById('patientPhone').textContent = patient.phone || 'N/A';
        document.getElementById('patientBloodGroup').textContent = patient.blood_group || 'N/A';
        document.getElementById('patientAllergies').textContent = patient.allergies || 'None';
        patientDetails.classList.remove('d-none');
    } else {
        patientDetails.classList.add('d-none');
    }
});

function addMedicineRow() {
    const template = document.getElementById('medicineRowTemplate');
    const clone = template.cloneNode(true);
    clone.id = 'medicineRow' + (++medicineRowCounter);
    clone.classList.remove('d-none');
    
    document.getElementById('medicineTableBody').appendChild(clone);
}

function removeMedicineRow(button) {
    button.closest('tr').remove();
    updateTotal();
}

function updateMedicinePrice(select) {
    const row = select.closest('tr');
    const price = select.selectedOptions[0]?.dataset.price || 0;
    row.dataset.price = price;
    updateRowTotal(row.querySelector('.quantity-input'));
}

function updateRowTotal(quantityInput) {
    const row = quantityInput.closest('tr');
    const price = parseFloat(row.dataset.price || 0);
    const quantity = parseInt(quantityInput.value || 0);
    row.dataset.total = price * quantity;
    updateTotal();
}

function updateTotal() {
    let total = 0;
    document.querySelectorAll('.medicine-row').forEach(row => {
        total += parseFloat(row.dataset.total || 0);
    });
    document.getElementById('totalAmount').textContent = total.toFixed(2);
}

// Add first medicine row by default
document.addEventListener('DOMContentLoaded', function() {
    addMedicineRow();
});
</script>
{% endblock %}